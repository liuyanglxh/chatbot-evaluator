# 功能更新总结 - 详细日志和测试数据管理

## 🎉 更新完成！

已完成两项重要功能更新：
1. **显示详细的评估原因和日志**
2. **测试数据管理功能**

---

## ✨ 功能1：详细评估原因和日志

### 问题描述
您提到：框架在评估的时候有显示原因吗？比如哪里成功或者哪里失败？

### 解决方案

#### 1. 提取 DeepEval 返回的详细信息

**文件**: `evaluators/deepeval_executor.py`

DeepEval 框架返回的 `MetricData` 包含以下字段：
- `name`: 指标名称
- `score`: 分数
- `success`: 是否通过
- `reason`: **评估原因（已添加）**
- `verbose_logs`: **详细日志（已添加）**
- `evaluation_model`: 评估模型
- `error`: 错误信息

**修改内容**：
```python
# 获取详细日志（如果有）
verbose_logs = getattr(metric_data, 'verbose_logs', None)

return {
    'success': True,
    'score': score,
    'passed': passed,
    'message': message,
    'reason': reason,
    'verbose_logs': verbose_logs,  # 新增
    'is_english': is_english
}
```

#### 2. 在弹窗中显示详细日志

**文件**: `windows/result_popup_window.py`

**新增功能**：
- 在"评估原因"卡片下方添加"📋 详细日志"区域
- 默认收起，点击"展开 ▼"按钮查看
- 深色背景（#2D3748）+ 浅色文字（#E2E8F0）
- 等宽字体（Courier New）便于查看日志

**效果**：
```
┌────────────────────────────────────┐
│ 📝 评估原因                        │
│                                    │
│ 该回答在事实方面与上下文一致...   │
│                                    │
│ ────────────────────────────────── │
│                                    │
│ 📋 详细日志              [展开 ▼] │
└────────────────────────────────────┘
    [点击展开后]
┌────────────────────────────────────┐
│ 📋 详细日志              [收起 ▲] │
│                                    │
│ ┌────────────────────────────────┐│
│ │ STEP 1: Checking if the...     ││
│ │ STEP 2: Evaluating...          ││
│ │ [详细评估步骤和得分]           ││
│ │                                ││
│ └────────────────────────────────┘│
└────────────────────────────────────┘
```

**实现方法**：
```python
def _toggle_log(self):
    """切换日志显示/隐藏"""
    if self.log_expanded:
        self.log_frame.pack_forget()
        self.toggle_button.config(text="展开 ▼")
        self.log_expanded = False
    else:
        self.log_frame.pack(fill=tk.BOTH, expand=True, pady=(10, 0))
        self.toggle_button.config(text="收起 ▲")
        self.log_expanded = True
```

---

## 📚 功能2：测试数据管理

### 需求描述
您提到：增加一个功能：添加测试数据，一条测试数据包含问题、回答、上下文。这些数据也要存起来。

### 解决方案

#### 1. 扩展配置管理器

**文件**: `config_manager.py`

**新增方法**：

```python
# 添加测试数据
def add_test_data(self, test_data):
    # test_data = {
    #     'name': '测试数据名称',
    #     'question': '问题',
    #     'answer': '回答',
    #     'context': '上下文（可选）'
    # }

# 获取所有测试数据
def get_test_data_list(self)

# 删除测试数据
def remove_test_data(self, test_name)

# 根据名称获取测试数据
def get_test_data_by_name(self, test_name)
```

**存储位置**：
- 配置文件中新增 `test_data` 字段
- 与评估器配置一起保存在 `config.json`

**配置示例**：
```json
{
  "model_settings": { ... },
  "evaluators": [ ... ],
  "test_data": [
    {
      "name": "保险理赔测试1",
      "question": "车险理赔需要准备哪些材料？",
      "answer": "需要准备事故责任认定书、维修发票...",
      "context": "车险理赔材料包括：1.事故责任认定书..."
    },
    {
      "name": "重疾险测试",
      "question": "重疾险的等待期是多久？",
      "answer": "重疾险等待期通常是90天或180天...",
      "context": ""
    }
  ]
}
```

#### 2. 测试数据管理窗口

**文件**: `windows/test_data_manager_window.py` (新增)

**功能**：
- 📋 **列表显示**：左侧显示所有测试数据（名称 + 问题摘要）
- ✏️ **详情编辑**：右侧显示和编辑详细信息
- ➕ **添加**：添加新的测试数据
- 💾 **保存**：保存测试数据
- 🗑 **删除**：删除选中的测试数据

**界面布局**：
```
┌──────────────────────────────────────────────┐
│          📚 测试数据管理                     │
├────────────────────┬─────────────────────────┤
│ 测试数据列表      │ 详细信息                │
│ ┌──────────────┐  │ ┌─────────────────────┐ │
│ │名称  │问题    │  │ │名称: [___________] │ │
│ ├──────────────┤  │ │                     │ │
│ │测试1 │车险...│  │ │问题:               │ │
│ │测试2 │重疾...│  │ │[文本框]            │ │
│ │...          │  │ │                     │ │
│ └──────────────┘  │ │回答:               │ │
│ [➕添加][✏️编辑]│  │ │[文本框]            │ │
│ [🗑删除][💾保存]│  │ │                     │ │
│                   │  │ │上下文:             │ │
│                   │  │ │[文本框]            │ │
│                   │  │ └─────────────────────┘ │
└────────────────────┴─────────────────────────┘
```

**使用方法**：
1. 点击"➕ 添加"：清空表单，输入新数据
2. 点击"💾 保存"：保存当前数据
3. 选择列表项：自动加载数据到表单
4. 点击"🗑 删除"：删除选中的数据

#### 3. 评估窗口集成测试数据选择

**文件**: `windows/evaluation_execution_window.py`

**新增功能**：
- 在输入区域顶部添加测试数据下拉选择框
- 自动加载所有已保存的测试数据
- 选择后自动填充问题、回答、上下文

**效果**：
```
┌──────────────────────────────────────┐
│ 输入数据                            │
│                                      │
│ 📚 选择测试数据: [下拉框 ▼] [加载]   │
│                                      │
│ 问题 *:                              │
│ ┌────────────────────────────────┐  │
│ │                                │  │
│ └────────────────────────────────┘  │
│                                      │
│ 回答 *:                              │
│ ┌────────────────────────────────┐  │
│ │                                │  │
│ │                                │  │
│ └────────────────────────────────┘  │
│                                      │
│ 上下文（可选）:                      │
│ ┌────────────────────────────────┐  │
│ │                                │  │
│ └────────────────────────────────┘  │
└──────────────────────────────────────┘
```

**实现方法**：
```python
def _load_test_data(self):
    """加载测试数据到下拉框"""
    test_data_list = self.config_manager.get_test_data_list()
    test_data_names = [td['name'] for td in test_data_list]
    self.test_data_combo['values'] = test_data_names

def _load_selected_test_data(self):
    """加载选中的测试数据"""
    selected_name = self.test_data_combo.get()
    test_data = self.config_manager.get_test_data_by_name(selected_name)

    if test_data:
        self.question_text.insert(1.0, test_data.get('question', ''))
        self.answer_text.insert(1.0, test_data.get('answer', ''))
        self.context_text.insert(1.0, test_data.get('context', ''))
```

#### 4. 主窗口添加入口

**文件**: `main.py`

**新增菜单**：
```
┌─────────────────┐
│ 功能菜单        │
├─────────────────┤
│ 设置            │
│  🔧 大模型设置  │
│                 │
│ 评估器          │
│  ➕ 添加评估器  │
│  📋 查看评估器  │
│                 │
│ 测试数据        │  ← 新增
│  📚 测试数据管理│  ← 新增
│                 │
│ ❌ 退出         │
└─────────────────┘
```

---

## 📊 用户体验提升

### 评估原因更详细
1. ✅ **简要原因**：评估原因卡片显示核心原因
2. ✅ **详细日志**：展开查看完整的评估步骤
3. ✅ **可追溯**：了解框架为什么给出这样的分数

### 测试数据管理
1. ✅ **保存复用**：常用测试数据保存起来，随时调用
2. ✅ **快速测试**：选择测试数据，一键加载，立即评估
3. ✅ **统一管理**：所有测试数据集中管理，方便维护

---

## 🚀 使用流程

### 查看详细评估日志

1. 执行评估
2. 结果弹窗自动弹出
3. 在"评估原因"卡片下方点击"展开 ▼"
4. 查看详细的评估步骤和日志

### 使用测试数据

#### 方式1：添加和使用测试数据

1. 打开主程序
2. 点击"📚 测试数据管理"
3. 点击"➕ 添加"
4. 输入测试数据：
   - 名称：如"车险理赔测试1"
   - 问题：如"车险理赔需要准备哪些材料？"
   - 回答：如"需要准备..."
   - 上下文：（可选）
5. 点击"💾 保存"
6. 关闭测试数据管理窗口
7. 选择评估器，点击"使用选中"
8. 在"📚 选择测试数据"下拉框中选择"车险理赔测试1"
9. 数据自动填充，点击"▶ 执行评估"

#### 方式2：直接手动输入

- 不选择测试数据，直接在输入框中手动输入

---

## 📁 修改的文件

### 修改文件
1. `evaluators/deepeval_executor.py` - 添加 verbose_logs 字段
2. `windows/result_popup_window.py` - 显示详细日志
3. `windows/evaluation_execution_window.py` - 集成测试数据选择
4. `config_manager.py` - 添加测试数据管理方法
5. `main.py` - 添加测试数据管理入口

### 新增文件
1. `windows/test_data_manager_window.py` - 测试数据管理窗口

---

## ✅ 功能清单

- [x] 提取 DeepEval 的 reason 字段
- [x] 提取 DeepEval 的 verbose_logs 字段
- [x] 在弹窗中显示详细日志
- [x] 添加可展开/收起的日志区域
- [x] 创建测试数据管理窗口
- [x] 实现测试数据的增删改查
- [x] 在评估窗口集成测试数据选择
- [x] 数据持久化到配置文件

---

## 🎯 下一步建议

1. **批量评估**：选择多个测试数据，批量执行评估
2. **数据导入/导出**：支持从 Excel/CSV 导入测试数据
3. **评估历史**：保存评估历史记录
4. **数据统计**：显示测试数据数量、评估次数等统计信息
5. **模板管理**：预置常用测试数据模板

---

**完成时间**: 2025-01-22
**新增功能**: 2项
**修改文件**: 5个
**新增文件**: 1个
**用户体验**: ⭐⭐⭐⭐⭐
