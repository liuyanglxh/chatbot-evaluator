"""
è¯„ä¼°æ‰§è¡Œçª—å£
æ‰§è¡Œå•ä¸ªè¯„ä¼°å™¨çš„è¯„ä¼°ä»»åŠ¡
"""
import tkinter as tk
from tkinter import ttk, messagebox, scrolledtext
import threading
import sys
from pathlib import Path

# æ·»åŠ çˆ¶ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, str(Path(__file__).parent.parent))
from config_manager import ConfigManager
from evaluators import get_executor


class EvaluationExecutionWindow:
    """è¯„ä¼°æ‰§è¡Œçª—å£"""

    def __init__(self, parent, evaluator_info):
        self.evaluator_info = evaluator_info
        self.config_manager = ConfigManager()

        # åˆ›å»ºæ–°çª—å£
        self.window = tk.Toplevel(parent)
        self.window.title(f"æ‰§è¡Œè¯„ä¼° - {evaluator_info['name']}")
        self.window.geometry("900x750")
        self.window.transient(parent)
        self.window.grab_set()

        # åˆ›å»ºç•Œé¢
        self.create_interface()

        # å±…ä¸­æ˜¾ç¤º
        self.center_window()

    def create_interface(self):
        """åˆ›å»ºç•Œé¢"""
        # ä¸»æ¡†æ¶
        main_frame = ttk.Frame(self.window, padding="20")
        main_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

        # æ ‡é¢˜ï¼ˆæ˜¾ç¤ºè¯„ä¼°å™¨ä¿¡æ¯ï¼‰
        title_text = f"è¯„ä¼°å™¨ï¼š{self.evaluator_info['name']}"
        subtitle_text = f"æ¡†æ¶ï¼š{self.evaluator_info['framework']} | ç±»å‹ï¼š{self.evaluator_info['metric_type']} | é˜ˆå€¼ï¼š{self.evaluator_info['threshold']}"

        title_label = ttk.Label(
            main_frame,
            text=title_text,
            font=("Arial", 16, "bold")
        )
        title_label.grid(row=0, column=0, columnspan=2, pady=(0, 5))

        subtitle_label = ttk.Label(
            main_frame,
            text=subtitle_text,
            font=("Arial", 10),
            foreground="gray"
        )
        subtitle_label.grid(row=1, column=0, columnspan=2, pady=(0, 20))

        # è¾“å…¥åŒºåŸŸ
        input_frame = ttk.LabelFrame(main_frame, text="è¾“å…¥æ•°æ®", padding="10")
        input_frame.grid(row=2, column=0, columnspan=2, sticky=(tk.W, tk.E), pady=(0, 15))

        # é—®é¢˜ï¼ˆå¿…å¡«ï¼‰
        ttk.Label(input_frame, text="é—®é¢˜ *:").grid(row=0, column=0, sticky=tk.W, pady=5)
        self.question_text = scrolledtext.ScrolledText(
            input_frame,
            width=60,
            height=4,
            font=("Arial", 11)
        )
        self.question_text.grid(row=1, column=0, sticky=(tk.W, tk.E), pady=5)

        # å›ç­”ï¼ˆå¿…å¡«ï¼‰
        ttk.Label(input_frame, text="å›ç­” *:").grid(row=2, column=0, sticky=tk.W, pady=5)
        self.answer_text = scrolledtext.ScrolledText(
            input_frame,
            width=60,
            height=6,
            font=("Arial", 11)
        )
        self.answer_text.grid(row=3, column=0, sticky=(tk.W, tk.E), pady=5)

        # ä¸Šä¸‹æ–‡ï¼ˆå¯é€‰ï¼‰
        ttk.Label(input_frame, text="ä¸Šä¸‹æ–‡ï¼ˆå¯é€‰ï¼‰:").grid(row=4, column=0, sticky=tk.W, pady=5)
        self.context_text = scrolledtext.ScrolledText(
            input_frame,
            width=60,
            height=4,
            font=("Arial", 11)
        )
        self.context_text.grid(row=5, column=0, sticky=(tk.W, tk.E), pady=5)

        input_frame.columnconfigure(0, weight=1)

        # æ‰§è¡ŒæŒ‰é’®
        button_frame = ttk.Frame(main_frame)
        button_frame.grid(row=3, column=0, columnspan=2, pady=(10, 15))

        execute_button = ttk.Button(
            button_frame,
            text="â–¶ æ‰§è¡Œè¯„ä¼°",
            command=self.execute_evaluation,
            width=15
        )
        execute_button.grid(row=0, column=0, padx=5)

        clear_button = ttk.Button(
            button_frame,
            text="ğŸ—‘ æ¸…ç©º",
            command=self.clear_inputs,
            width=15
        )
        clear_button.grid(row=0, column=1, padx=5)

        # ç»“æœåŒºåŸŸ
        result_frame = ttk.LabelFrame(main_frame, text="è¯„ä¼°ç»“æœ", padding="10")
        result_frame.grid(row=4, column=0, columnspan=2, sticky=(tk.W, tk.E, tk.N, tk.S), pady=(0, 15))

        # ç»“æœæ–‡æœ¬æ¡†
        self.result_text = scrolledtext.ScrolledText(
            result_frame,
            width=80,
            height=12,
            font=("Arial", 10),
            state=tk.DISABLED
        )
        self.result_text.pack(fill=tk.BOTH, expand=True)

        # å…³é—­æŒ‰é’®
        close_button = ttk.Button(
            main_frame,
            text="å…³é—­",
            command=self.window.destroy,
            width=15
        )
        close_button.grid(row=5, column=0, columnspan=2, pady=(0, 10))

        # é…ç½®ç½‘æ ¼æƒé‡
        self.window.columnconfigure(0, weight=1)
        self.window.rowconfigure(0, weight=1)
        main_frame.columnconfigure(0, weight=1)
        main_frame.rowconfigure(4, weight=1)

    def clear_inputs(self):
        """æ¸…ç©ºè¾“å…¥"""
        self.question_text.delete(1.0, tk.END)
        self.answer_text.delete(1.0, tk.END)
        self.context_text.delete(1.0, tk.END)
        self.result_text.config(state=tk.NORMAL)
        self.result_text.delete(1.0, tk.END)
        self.result_text.config(state=tk.DISABLED)

    def execute_evaluation(self):
        """æ‰§è¡Œè¯„ä¼°"""
        # è·å–è¾“å…¥
        question = self.question_text.get(1.0, tk.END).strip()
        answer = self.answer_text.get(1.0, tk.END).strip()
        context = self.context_text.get(1.0, tk.END).strip()

        # éªŒè¯å¿…å¡«é¡¹
        if not question:
            messagebox.showerror("é”™è¯¯", "è¯·è¾“å…¥é—®é¢˜")
            return

        if not answer:
            messagebox.showerror("é”™è¯¯", "è¯·è¾“å…¥å›ç­”")
            return

        # æ¸…ç©ºç»“æœåŒºåŸŸ
        self.result_text.config(state=tk.NORMAL)
        self.result_text.delete(1.0, tk.END)
        self.result_text.insert(tk.END, "â³ æ­£åœ¨æ‰§è¡Œè¯„ä¼°ï¼Œè¯·ç¨å€™...\n\n")
        self.result_text.config(state=tk.DISABLED)

        # åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œè¯„ä¼°
        thread = threading.Thread(
            target=self._execute_evaluation_thread,
            args=(question, answer, context)
        )
        thread.daemon = True
        thread.start()

    def _execute_evaluation_thread(self, question, answer, context):
        """åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œè¯„ä¼°"""
        try:
            # è·å–å¤§æ¨¡å‹é…ç½®
            model_settings = self.config_manager.get_model_settings()

            # è·å–è¯„ä¼°æ‰§è¡Œå™¨
            executor = get_executor(self.evaluator_info)

            # æ‰§è¡ŒçœŸå®è¯„ä¼°
            result = executor.execute(question, answer, context, model_settings)

            # æ›´æ–° UI
            self.window.after(0, self._update_result, result)

        except Exception as e:
            import traceback
            error_message = str(e)
            error_traceback = traceback.format_exc()

            # æ˜¾ç¤ºé”™è¯¯å¼¹çª—
            self.window.after(0, self._show_error_dialog, error_message, error_traceback)

    def _show_error_dialog(self, error_message, error_traceback):
        """æ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡†"""
        # åˆ¤æ–­é”™è¯¯ç±»å‹
        is_translation_error = "ç¿»è¯‘å¤±è´¥" in error_message
        dialog_title = "ç¿»è¯‘å¤±è´¥" if is_translation_error else "è¯„ä¼°å¤±è´¥"
        dialog_header = "ç¿»è¯‘æ‰§è¡Œå¤±è´¥" if is_translation_error else "è¯„ä¼°æ‰§è¡Œå¤±è´¥"

        # åˆ›å»ºå¼¹çª—
        dialog = tk.Toplevel(self.window)
        dialog.title(dialog_title)
        dialog.geometry("700x500")
        dialog.transient(self.window)
        dialog.grab_set()

        # ä¸»æ¡†æ¶
        main_frame = ttk.Frame(dialog, padding="20")
        main_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

        # é”™è¯¯å›¾æ ‡
        error_label = ttk.Label(
            main_frame,
            text="âŒ",
            font=("Arial", 48)
        )
        error_label.grid(row=0, column=0, pady=(0, 10))

        # é”™è¯¯æ ‡é¢˜
        title_label = ttk.Label(
            main_frame,
            text=dialog_header,
            font=("Arial", 16, "bold")
        )
        title_label.grid(row=1, column=0, pady=(0, 20))

        # ä¸»æ¡†æ¶
        main_frame = ttk.Frame(dialog, padding="20")
        main_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

        # é”™è¯¯å›¾æ ‡
        error_label = ttk.Label(
            main_frame,
            text="âŒ",
            font=("Arial", 48)
        )
        error_label.grid(row=0, column=0, pady=(0, 10))

        # é”™è¯¯æ ‡é¢˜
        title_label = ttk.Label(
            main_frame,
            text="è¯„ä¼°æ‰§è¡Œå¤±è´¥",
            font=("Arial", 16, "bold")
        )
        title_label.grid(row=1, column=0, pady=(0, 20))

        # é”™è¯¯ä¿¡æ¯æ¡†æ¶
        error_frame = ttk.LabelFrame(main_frame, text="é”™è¯¯ä¿¡æ¯", padding="10")
        error_frame.grid(row=2, column=0, sticky=(tk.W, tk.E), pady=(0, 15))

        # é”™è¯¯æ¶ˆæ¯æ–‡æœ¬æ¡†
        error_text = scrolledtext.ScrolledText(
            error_frame,
            width=70,
            height=10,
            font=("Courier New", 10),
            wrap=tk.WORD
        )
        error_text.pack(fill=tk.BOTH, expand=True)

        # æ’å…¥å®Œæ•´çš„é”™è¯¯ä¿¡æ¯å’Œå †æ ˆè·Ÿè¸ª
        full_error = f"é”™è¯¯æ¶ˆæ¯ï¼š\n{error_message}\n\nè¯¦ç»†å †æ ˆï¼š\n{error_traceback}"
        error_text.insert(1.0, full_error)
        error_text.config(state=tk.DISABLED)

        # æŒ‰é’®æ¡†æ¶
        button_frame = ttk.Frame(main_frame)
        button_frame.grid(row=3, column=0, pady=(10, 0))

        # å¤åˆ¶é”™è¯¯ä¿¡æ¯æŒ‰é’®
        copy_button = ttk.Button(
            button_frame,
            text="ğŸ“‹ å¤åˆ¶é”™è¯¯ä¿¡æ¯",
            command=lambda: self._copy_error_to_clipboard(full_error, dialog),
            width=20
        )
        copy_button.grid(row=0, column=0, padx=5)

        # å…³é—­æŒ‰é’®
        close_button = ttk.Button(
            button_frame,
            text="å…³é—­",
            command=dialog.destroy,
            width=15
        )
        close_button.grid(row=0, column=1, padx=5)

        # é…ç½®ç½‘æ ¼æƒé‡
        dialog.columnconfigure(0, weight=1)
        dialog.rowconfigure(0, weight=1)
        main_frame.columnconfigure(0, weight=1)
        error_frame.columnconfigure(0, weight=1)
        main_frame.rowconfigure(2, weight=1)

        # å±…ä¸­æ˜¾ç¤º
        self._center_dialog(dialog)

        # ä¿å­˜ full_error ä¾›å¤åˆ¶ä½¿ç”¨
        dialog.error_full_text = full_error

    def _copy_error_to_clipboard(self, error_text, dialog):
        """å¤åˆ¶é”™è¯¯ä¿¡æ¯åˆ°å‰ªè´´æ¿"""
        try:
            dialog.clipboard_clear()
            dialog.clipboard_append(error_text)
            dialog.update()

            # æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
            original_text = dialog.focus_get()
            if original_text and hasattr(original_text, 'cget'):
                try:
                    original_btn = original_text
                    if isinstance(original_btn, ttk.Button):
                        # ä¸´æ—¶æ›´æ”¹æŒ‰é’®æ–‡æœ¬
                        original_text_var = None
                except:
                    pass

            # ç®€å•æç¤º
            messagebox.showinfo("å¤åˆ¶æˆåŠŸ", "é”™è¯¯ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")
        except Exception as e:
            messagebox.showerror("å¤åˆ¶å¤±è´¥", f"æ— æ³•å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼š{str(e)}")

    def _center_dialog(self, dialog):
        """çª—å£å±…ä¸­æ˜¾ç¤º"""
        dialog.update_idletasks()

        width = dialog.winfo_width()
        height = dialog.winfo_height()

        screen_width = dialog.winfo_screenwidth()
        screen_height = dialog.winfo_screenheight()

        x = (screen_width - width) // 2
        y = (screen_height - height) // 2

        dialog.geometry(f'{width}x{height}+{x}+{y}')

    def _update_result(self, result):
        """æ›´æ–°ç»“æœæ˜¾ç¤º - ä½¿ç”¨å¼¹çª—"""
        if result['success']:
            # æ˜¾ç¤ºç»“æœå¼¹çª—
            from windows.result_popup_window import ResultPopupWindow
            ResultPopupWindow(self.window, result, self.evaluator_info)

            # åŒæ—¶åœ¨åŸçª—å£æ˜¾ç¤ºç®€ç•¥ä¿¡æ¯
            self._show_summary_in_window(result)
        else:
            # æ˜¾ç¤ºé”™è¯¯
            self._display_error_result(result.get('message', 'è¯„ä¼°å¤±è´¥'))

    def _show_summary_in_window(self, result):
        """åœ¨åŸçª—å£æ˜¾ç¤ºç®€ç•¥ä¿¡æ¯"""
        self.result_text.config(state=tk.NORMAL)
        self.result_text.delete(1.0, tk.END)

        score = result.get('score', 0.0)
        passed = result.get('passed', False)

        # é…ç½®ç®€å•æ ·å¼
        self.result_text.tag_config("success", foreground="#48BB78", font=("Arial", 14, "bold"))
        self.result_text.tag_config("failure", foreground="#F56565", font=("Arial", 14, "bold"))
        self.result_text.tag_config("normal", foreground="#2D3748", font=("Arial", 11))

        # æ˜¾ç¤ºç®€ç•¥ä¿¡æ¯
        status = "âœ… é€šè¿‡" if passed else "âŒ å¤±è´¥"
        status_tag = "success" if passed else "failure"

        self.result_text.insert(tk.END, "è¯„ä¼°å®Œæˆï¼\n\n", "normal")
        self.result_text.insert(tk.END, f"{status}\n", status_tag)
        self.result_text.insert(tk.END, f"å¾—åˆ†: {score:.3f}\n", "normal")
        self.result_text.insert(tk.END, f"\nè¯¦ç»†ä¿¡æ¯å·²åœ¨å¼¹çª—ä¸­æ˜¾ç¤ºã€‚", "normal")

        self.result_text.config(state=tk.DISABLED)

        except Exception as e:
            # ç¿»è¯‘å‡ºé”™æ—¶è¿”å›åŸæ–‡
            print(f"ç¿»è¯‘å¤±è´¥: {str(e)}")
            return reason_text

    def center_window(self):
        """çª—å£å±…ä¸­æ˜¾ç¤º"""
        self.window.update_idletasks()

        width = self.window.winfo_width()
        height = self.window.winfo_height()

        screen_width = self.window.winfo_screenwidth()
        screen_height = self.window.winfo_screenheight()

        x = (screen_width - width) // 2
        y = (screen_height - height) // 2

        self.window.geometry(f'{width}x{height}+{x}+{y}')
